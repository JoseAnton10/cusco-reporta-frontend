<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Usuario - Cusco Reporta</title>

  <link rel="stylesheet" href="../css/styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    .welcome-card{
      background:#fff;
      border-radius:14px;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      padding:28px;
      min-height: 420px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    .welcome-card h1{ margin:0; }
    .welcome-card p{ color:#666; margin-top:10px; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#f4f6f8;
      color:#333;
      font-weight:700;
      margin-top:14px;
    }
  </style>
</head>

<body>
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbar__logo">
      <img src="../assents/images/CuscoReporta.png" alt="Cusco Reporta Logo">
    </div>
    <nav class="topbar__menu">
      <a href="index.html">Inicio</a>
      <a href="sobre_nosotros.html">Sobre nosotros</a>
      <a href="ayuda.html">Ayuda</a>
    </nav>
  </header>

  <div class="container">
    <!-- SIDEBAR -->
    <aside class="sidebar" style="display:flex;flex-direction:column;justify-content:flex-start;">
      <div class="sidebar__user" style="margin-bottom:10px;">
        <div class="sidebar__avatar">
          <i class="fa-solid fa-user"></i>
        </div>
        <div class="sidebar__info">
          <h3 id="sbUsername">—</h3>
          <p id="sbRol">—</p>
        </div>
      </div>

      <ul class="sidebar__menu" style="margin-top:0;padding-top:0;list-style:none;">
        <li>
          <a href="perfil_usuario.html">
            <i class="fa-solid fa-id-card" style="width:20px;"></i>
            <span style="margin-left:8px;">Ver perfil</span>
          </a>
        </li>

        <!-- ✅ SOLO UNA OPCIÓN: Reportar / Denunciar -->
        <li>
          <a href="reportar_denuncia.html">
            <i class="fa-solid fa-triangle-exclamation" style="width:20px;"></i>
            <span style="margin-left:8px;">Reportar / Denunciar</span>
          </a>
        </li>

        <li>
          <a href="lista_incidencias.html">
            <i class="fa-solid fa-list-check" style="width:20px;"></i>
            <span style="margin-left:8px;">Estado de reportes</span>
          </a>
        </li>

        <li>
          <a href="MapaIncidiencias(Ciudadano).html">
            <i class="fa-solid fa-map-location-dot" style="width:20px;"></i>
            <span style="margin-left:8px;">Mapa de incidencias</span>
          </a>
        </li>

        <li>
          <a href="notificaciones.html">
            <i class="fa-solid fa-bell" style="width:20px;"></i>
            <span style="margin-left:8px;">Notificaciones</span>
          </a>
        </li>
      </ul>

      <button class="logout-btn" id="logoutBtn" style="margin-top:auto;">
        <i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión
      </button>
    </aside>

    <!-- CONTENT -->
    <main class="main-content">
      <div class="welcome-card">
        <div>
          <h1>¡Bienvenido, <span id="nombrePantalla">Usuario</span>!</h1>
          <p>Selecciona una opción del menú lateral para comenzar.</p>

          <div class="pill" id="pillSession">
            <i class="fa-solid fa-circle-check"></i>
            <span>Sesión activa</span>
          </div>

          <div style="margin-top:18px;">
            <a href="reportar_denuncia.html" class="boton red" style="text-decoration:none; display:inline-block;">
              <i class="fa-solid fa-triangle-exclamation"></i> Ir a Reportar / Denunciar
            </a>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    function getUserFromStorage() {
      // Soporta ambos: "user" y "token"
      const userRaw = localStorage.getItem("user");
      const token = localStorage.getItem("token");

      if (!userRaw || !token) return null;

      try { return JSON.parse(userRaw); }
      catch { return null; }
    }

    function rolLabel(rol_id) {
      // Ajusta si tus roles son distintos
      if (Number(rol_id) === 2) return "Administrador";
      return "Ciudadano";
    }

    function requireAuth() {
      const u = getUserFromStorage();
      if (!u) {
        // sin sesión, fuera
        window.location.href = "iniciar-sesion.html";
        return null;
      }
      return u;
    }

    function setSidebarUser(u) {
      const sbUsername = document.getElementById("sbUsername");
      const sbRol = document.getElementById("sbRol");
      const nombrePantalla = document.getElementById("nombrePantalla");

      const nombre = u.nombre_completo || u.username || "Usuario";
      sbUsername.textContent = u.username || nombre;
      sbRol.textContent = rolLabel(u.rol_id);
      nombrePantalla.textContent = nombre;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const u = requireAuth();
      if (!u) return;

      setSidebarUser(u);

      document.getElementById("logoutBtn").addEventListener("click", () => {
        if (confirm("¿Estás seguro de que quieres cerrar sesión?")) {
          localStorage.removeItem("token");
          localStorage.removeItem("user");
          window.location.href = "index.html";
        }
      });
    });
  </script>
</body>
</html>
